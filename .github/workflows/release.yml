name: Android Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

jobs:
  release:
    name: Release Build
    runs-on: ubuntu-latest

    env:
      VERSION: ${{ github.ref_name }}

    steps:
      # 1Ô∏è‚É£ Checkout (TAG + history ≈üart)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Gradle Cache
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/*.gradle.kts') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4Ô∏è‚É£ Gradlew permission
      - name: Grant execute permission
        run: chmod +x ./gradlew

      # 5Ô∏è‚É£ √ñnceki TAG
      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | sed -n '2p')
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      # 6Ô∏è‚É£ Release Notes √ºret
      - name: Generate Release Notes
        run: |
          echo "## üöÄ Release ${VERSION}" > release-notes.md
          echo "" >> release-notes.md

          if [ -z "$PREV_TAG" ]; then
            echo "üéâ Initial release" >> release-notes.md
          else
            echo "### Changes since $PREV_TAG" >> release-notes.md
            git log ${PREV_TAG}..HEAD \
              --pretty=format:"- %s (%an)" \
              >> release-notes.md
          fi

      # 7Ô∏è‚É£ Release Notes ‚Üí Job Summary
      - name: Publish Release Notes to Summary
        run: |
          cat release-notes.md >> $GITHUB_STEP_SUMMARY

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > release.keystore

      - name: Build Signed Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew bundleRelease

      # 9Ô∏è‚É£ AAB Artifact
      - name: Upload Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: release-aab-${{ env.VERSION }}
          path: app/build/outputs/bundle/release/*.aab

      # üîü Release Notes Artifact
      - name: Upload Release Notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ env.VERSION }}
          path: release-notes.md
